# Phase 5 Quickstart: AI-Powered Insights

## üöÄ Quick Start

### 1. Get Gemini API Key (Optional)

**For AI-powered insights:**
1. Visit: https://makersuite.google.com/app/apikey
2. Sign in with Google
3. Click "Create API Key"
4. Copy the key

### 2. Configure Environment

**Option A: Environment Variable**
```bash
# Windows PowerShell
$env:GEMINI_API_KEY="your_api_key_here"

# Linux/macOS
export GEMINI_API_KEY="your_api_key_here"
```

**Option B: .env File**
```env
# Copy .env.example to .env
GEMINI_API_KEY=your_api_key_here
GEMINI_MODEL=gemini-1.5-flash
GEMINI_TEMPERATURE=0.7
GEMINI_MAX_TOKENS=2048
```

### 3. Run Test (Rule-Based Mode)

**Without API key - tests rule-based fallback:**
```bash
python test_ai_insights.py
```

**Expected output:**
```
================================================================================
 PHASE 5: AI-POWERED INSIGHTS TEST SUITE
================================================================================

‚ö†Ô∏è  GEMINI_API_KEY not found in environment
   AI will use rule-based fallback mode

--------------------------------------------------------------------------------

‚è≠Ô∏è  Skipping Test 1 (no API key)

================================================================================
Test 2: Rule-Based Insights (No API Key)
================================================================================

üìπ Analyzing video: sample_video.mp4
ü§ñ AI insights: Enabled (will fallback to rule-based)
üîë API key: None (testing fallback)

[  0%] Extracting video metadata...
[ 10%] Extracting frames...
[ 50%] Detecting people in frames...
[ 92%] Generating enhanced analytics...
[ 95%] Generating AI insights...
[100%] Analysis complete!

================================================================================
üîß RULE-BASED INSIGHTS
================================================================================
Generated by: rule-based

üìù Summary: Analysis of 01:47 video reveals low crowd levels...

üîç Key Findings (5):
   1. Average occupancy: 1.1 people (Very Low density)
   2. Peak congestion: 4 people at 01:31
   3. Detected 4 bottleneck period(s) requiring attention
   4. Crowd concentration in: Unknown zones
   5. Crowd flow trend: Stable with moderate variability

‚úÖ Rule-based fallback working correctly!
================================================================================
```

### 4. Use in Python Code

```python
from app.services.video_analysis import VideoAnalysisService
from pathlib import Path

# Create service with AI insights enabled
service = VideoAnalysisService(
    frame_sample_rate=30,
    confidence_threshold=0.5,
    enable_ai_insights=True,
    gemini_api_key=None  # Uses env var or falls back to rule-based
)

# Analyze video
results = service.analyze_video(
    video_path=Path("sample_video.mp4"),
    save_detections=True
)

# Access AI insights
ai_insights = results.get("ai_insights", {})

print("=== AI INSIGHTS ===")
print(f"Summary: {ai_insights['ai_summary']}")
print(f"\nKey Findings:")
for i, finding in enumerate(ai_insights['key_findings'], 1):
    print(f"  {i}. {finding}")

print(f"\nStaff Recommendations:")
staff = ai_insights['staff_suggestions']
print(f"  - Nurses needed: {staff['suggested_nurses']}")
print(f"  - Reasoning: {staff['reasoning']}")

print(f"\nPriority Actions:")
for i, action in enumerate(ai_insights['priority_actions'], 1):
    print(f"  {i}. {action}")
```

### 5. Use via API

**Start analysis with AI insights:**
```bash
curl -X POST "http://localhost:8000/api/analyze/video-123" \
  -H "Content-Type: application/json" \
  -d '{
    "upload_id": "video-123",
    "enable_ai_insights": true,
    "frame_sample_rate": 30,
    "confidence_threshold": 0.5
  }'
```

**Response:**
```json
{
  "analysis_id": "abc-def-ghi",
  "status": "processing",
  "message": "Video analysis started. Use /analyze/status/{analysis_id} to check progress. AI-powered insights will be generated."
}
```

**Get results:**
```bash
curl "http://localhost:8000/api/analyze/results/abc-def-ghi"
```

## üìä Output Structure

```json
{
  "status": "completed",
  "video_metadata": {...},
  "statistics": {...},
  "insights": {...},
  "enhanced_analytics": {...},
  "ai_insights": {
    "ai_summary": "Executive summary of situation...",
    "key_findings": [
      "Finding 1",
      "Finding 2"
    ],
    "recommendations": [
      "Long-term recommendation 1",
      "Long-term recommendation 2"
    ],
    "staff_suggestions": {
      "suggested_nurses": 2,
      "reasoning": "Based on average crowd of 12.5 people..."
    },
    "bottleneck_areas": [
      "Center zone",
      "Time 00:00:40 - 00:00:50 (Critical)"
    ],
    "priority_actions": [
      "Deploy 2 nurse(s) to waiting area",
      "Focus resources during peak time"
    ],
    "generated_by": "rule-based",
    "generated_at": "2024-01-15T10:30:00"
  }
}
```

## üß† How It Works

### AI Mode (with API key)
1. **Collect Data:** Gathers all Phase 4 analytics
2. **Build Prompt:** Creates comprehensive prompt with:
   - Video metadata
   - Crowd statistics
   - Density analysis
   - Bottleneck details
   - Spatial distribution
   - Flow metrics
3. **Call Gemini:** Sends to Google Gemini API
4. **Parse Response:** Extracts structured insights
5. **Return Results:** Adds to analysis results

### Rule-Based Mode (no API key)
1. **Collect Data:** Same analytics data
2. **Apply Rules:** Uses predefined logic:
   - High density ‚Üí Increase staff
   - Bottlenecks ‚Üí Focus on peak times
   - Hotspots ‚Üí Position staff strategically
3. **Generate Insights:** Creates structured output
4. **Return Results:** Same format as AI mode

### Benefits
- **Graceful Fallback:** Never fails due to API issues
- **Cost-Effective:** Rule-based mode is free
- **Consistent Output:** Same structure regardless of mode
- **AI Enhancement:** Better insights with Gemini when available

## üéØ Key Features

### 1. Natural Language Summaries
- Executive-level overview
- Easy to understand for non-technical users
- Actionable recommendations

### 2. Staff Recommendations
- Nurse count suggestions
- Detailed reasoning based on data
- Peak time considerations

### 3. Bottleneck Identification
- Specific times requiring attention
- Severity levels
- Zone-based analysis

### 4. Priority Actions
- Immediate steps to take
- Numbered list for clarity
- Data-driven decisions

### 5. Long-term Recommendations
- Operational improvements
- Capacity planning
- Process optimization

## üîß Configuration Options

### Service Parameters

```python
VideoAnalysisService(
    frame_sample_rate=30,          # Process every 30th frame
    confidence_threshold=0.5,       # Detection confidence
    enable_ai_insights=True,        # Enable AI insights
    gemini_api_key=None            # API key or None for env var
)
```

### Environment Variables

```env
GEMINI_API_KEY=your_key_here       # Required for AI mode
GEMINI_MODEL=gemini-1.5-flash      # Model: flash (fast) or pro (quality)
GEMINI_TEMPERATURE=0.7              # 0.0-1.0: creativity level
GEMINI_MAX_TOKENS=2048             # Response length
```

### API Request

```json
{
  "upload_id": "video-123",
  "enable_ai_insights": true,        // Enable/disable AI
  "gemini_api_key": "your_key",      // Optional: override env var
  "frame_sample_rate": 30,
  "confidence_threshold": 0.5
}
```

## üß™ Testing

### Full Test Suite
```bash
python test_ai_insights.py
```

**Tests 3 modes:**
1. **Gemini AI** (if API key available)
2. **Rule-Based Fallback** (no API key)
3. **AI Disabled** (enable_ai_insights=False)

### Quick Python Test
```python
from app.services.gemini_assistant import generate_quick_insights

# Generate insights from existing results
insights = generate_quick_insights(results, api_key="your_key")
print(insights["ai_summary"])
```

## üìà Performance

| Mode | Speed | Quality | Cost |
|------|-------|---------|------|
| **Rule-Based** | ‚ö° Instant | ‚úÖ Good | üí∞ Free |
| **Gemini Flash** | ‚ö° 2-5s | üåü Excellent | üí∞ $0.0003/analysis |
| **Gemini Pro** | üêå 5-10s | üåüüåü Outstanding | üí∞ $0.001/analysis |

**Recommendation:** Use **gemini-1.5-flash** for production (fast + cheap + excellent quality)

## üõ°Ô∏è Error Handling

### Scenario 1: No API Key
- **Behavior:** Automatically uses rule-based mode
- **Output:** `"generated_by": "rule-based"`
- **Quality:** Good, data-driven recommendations

### Scenario 2: Invalid API Key
- **Behavior:** Catches error, falls back to rule-based
- **Output:** `"generated_by": "rule-based"`
- **Logging:** Error logged for debugging

### Scenario 3: API Quota Exceeded
- **Behavior:** Catches error, falls back to rule-based
- **Output:** `"generated_by": "rule-based"`
- **Message:** Check logs for quota error

### Scenario 4: AI Disabled
- **Behavior:** Skips AI insights generation
- **Output:** No `ai_insights` key in results
- **Speed:** Saves 2-5 seconds

## üìö Documentation

- **Full Docs:** `docs/PHASE5_AI_INSIGHTS.md`
- **Test Script:** `test_ai_insights.py`
- **Service Code:** `app/services/gemini_assistant.py`
- **Integration:** `app/services/video_analysis.py`

## ‚úÖ Verification

**Confirm Phase 5 is working:**

```bash
# 1. Run test (rule-based)
python test_ai_insights.py

# 2. Check for success
# Should see: "‚úÖ Rule-based fallback working correctly!"

# 3. Optional: Test with Gemini
export GEMINI_API_KEY="your_key"
python test_ai_insights.py

# 4. Check for AI mode
# Should see: "Generated by: gemini-ai"
```

## üéâ Next Steps

### Phase 6: AI Assistant Chat
- Interactive Q&A about analysis
- "Why do you recommend X nurses?"
- "What if we only have Y staff?"
- "How can we reduce bottlenecks?"
- Conversation context management

**Coming soon!**

---

## üÜò Troubleshooting

### Issue: No AI insights in output
**Solution:** Check `enable_ai_insights=True` in service initialization

### Issue: Always uses rule-based mode
**Solution:** Verify `GEMINI_API_KEY` environment variable set correctly

### Issue: "Unknown" zones in hotspots
**Solution:** This is expected with low crowd density. More people = better spatial analysis.

### Issue: Slow AI generation
**Solution:** Switch from `gemini-1.5-pro` to `gemini-1.5-flash`

---

**Phase 5 Status:** ‚úÖ COMPLETE

**What's New:**
- ‚úÖ AI-powered natural language insights
- ‚úÖ Gemini API integration
- ‚úÖ Rule-based fallback mode
- ‚úÖ Staff recommendations with reasoning
- ‚úÖ Bottleneck identification
- ‚úÖ Priority actions
- ‚úÖ Comprehensive documentation
- ‚úÖ Test suite with 3 modes

**Ready for Phase 6!** üöÄ
